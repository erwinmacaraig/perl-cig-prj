[% IF FlashMessage.flash.type %]
<div class="col-md-12">
    <div class="alert alert-warning" role="alert">
        <div>
        [% IF FlashMessage.flash.type == 'success' %]
            <span class="fa flash_success fa-exclamation"></span>
            <p>[% FlashMessage.flash.message %]</p>
        [% ELSIF FlashMessage.flash.type == 'error' %]
            <span class="fa flash_error fa-exclamation"></span>
            <p>[% FlashMessage.flash.message %]</p>
        [% END %]
        <br/>
        </div>
    </div>
</div>
[% END %]


[% IF Notifications.size %]
    <div class="col-md-9">
        <div class="alert alert-info" role="alert">
            <ul>
            [% FOREACH message IN Notifications %]
                <li>[% message.value %]</li>
            [% END %]
            </ul>
        </div>
    </div>
[% END %]

<div class="col-md-9 tasklist-content dashboard-tasklist">
	<table id="worktasks" cellpadding="5" width="100%">
		<thead>
			<tr class="box-header">
				<th>[% Lang.txt('Tasklist') %] [% IF TaskCounts.newTasks %]<span style="color: red">[% TaskCounts.newTasks %]</span>[% END %]</th>
				<th>[% Lang.txt('Started') %]</th>
				<th>[% Lang.txt('Status') %]</th>
				<th>[% Lang.txt('Actions') %]</th>
			</tr>
			<tr class="order-override">
				<td><!--Filter by:-->
					<select class="filter-tasks" style="width: 100%">
			          <option selected="" value="">-- All --</option>
                      <!--
			          <option value="New Registration">New Registration</option>
			          <option value="Renewal">Renewal</option>
			          <option value="Transfer">Transfer</option>
                      -->
                      [% FOREACH taskType IN TaskFilters.type %]
                          [% IF taskType %]
                          <option value="[% taskType %]">[% taskType %]</option>
                          [% END %]
                      [% END %]
			        </select>
		        </td>
				<td>
					<select class="sort-date">
			          <option value="asc">-- Sort --</option>
			          <option value="desc">Latest</option>
			          <option value="asc">Oldest</option>
			        </select>
				</td>
				<td>
					<select class="filter-status" id="u53_input">
			          <option value="">-- All --</option>
                      [% IF CurrentLevel == 100 OR CurrentLevel == 20 %]
                      <option value="Ready to Approve">Ready to Approve</option>
                      [% END %]
                      <option value="Task On Hold">Task On Hold</option>
                      <!--
                      [% FOREACH taskStatus IN TaskFilters.status %]
                      <option value="[% taskStatus %]">[% taskStatus %]</option>
                      [% END %]
                        -->
			        </select>
				</td>
				<td class="list-action-filter">
                    <select name="d_intTaskType" id="l_intTaskType" class="fcToogleGroup" style="display: none">
                        <option value="all_tasks">[% Lang.txt('All tasks') %]</option>
                        <option value="new_task">[% Lang.txt('New task') %]</option>
                    </select>
				</td>
			</tr>
			<tr style="display: none" class="box-header">
				<th>[% Lang.txt('Tasklist') %]</th>
				<th>[% Lang.txt('Started') %]</th>
				<th>[% Lang.txt('Status') %]</th>
				<th>[% Lang.txt('Actions') %]</th>
			</tr>

		</thead>
		<tbody>
		    [% FOREACH task IN TaskList %]
                <tr class="task-list [% IF task.newTask %]new-task[% END %]">
                    [% IF task.TaskType == 'TRANSFER' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span style="float: left" class="fa fa-user"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.personRequestLabel %]<br/>
                            [% IF task.TaskStatus == 'ACCEPTED' %]
                                [% task.requestTo %] has accepted request for [% task.Name %]
                            [% ELSIF task.TaskStatus == 'PENDING' %]
                                [% task.requestFrom %] has requested a transfer for [% task.Name %]
                            [% END %]
                            </div>
                        </td>
                    [% ELSIF task.TaskType == 'ACCESS' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span style="float: left" class="fa fa-user"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.personRequestLabel %]<br/>
                            [% task.Name %] from <br/>
                            [% task.requestFrom %]
                            </div>
                        </td>
                    [% ELSIF task.TaskType == 'APPROVAL' AND task.RuleFor == 'REGO' AND task.RegistrationNature == 'TRANSFER' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span class="fa fa-user" style="float: left"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.RegistrationNatureLabel %]<br/>
                            Review Transfer of [% task.Name %]<br/>
                            From [% task.RequestToClub %] to [% task.RequestFromClub %]<br/>
                            </div>
                        </td>
                    [% ELSIF task.TaskType == 'APPROVAL' AND task.RuleFor == 'REGO' AND task.RegistrationNature != 'TRANSFER' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span class="fa fa-user" style="float: left"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.RegistrationNatureLabel %]<br/>
                            [% task.Name %]<br/>
                            [% task.LocalEntityName %]
                            </div>
                        </td>
                    [% ELSIF task.TaskType == 'APPROVAL' AND task.RuleFor == 'ENTITY' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span class="fa fa-user" style="float: left"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.RegistrationNatureLabel %]<br/>
                            [% task.Name %]
                            </div>
                        </td>
                    [% ELSIF task.TaskType == 'APPROVAL' AND task.RuleFor == 'PERSON' %]
                        <td style="word-wrap: break-word;width: 280px;">
                            <span class="fa fa-user" style="float: left"></span>
                            <div style="float: left; word-wrap: break-word;width: 80%;">
                            [% task.RegistrationNatureLabel %]<br/>
                            [% task.Name %]
                            </div>
                        </td>
		            [% ELSE %]
                        <td><span class="fa fa-user"></span>Rego [% task.Name %]</td>
		            [% END %]
                    <td>[% task.taskDate %]</td>

                    <td><span class="fa fa-clock-o"></span>[% task.TaskStatusLabel %]</td>

                    [% IF task.TaskType == 'APPROVAL' %]

                        [% IF CurrentLevel == 100 OR CurrentLevel == 20 %]
                            <td><a href="[% task.viewURL %]" class="btn-inside-panels">[% Lang.txt('View and Approve') %]</a></td>
                        [% ELSE %]
                            <td class="just-view-text"><a href="[% task.viewURL %]" class="btn-inside-panels">[% Lang.txt('View') %]</a></td>
                        [% END %]

                    [% ELSIF task.TaskType == 'TRANSFER' %]

                        [% IF task.currentClubView == 1 %]
                            <td><a href="[% task.viewURL %]" class="btn-inside-panels">[% Lang.txt('View and Approve') %]</a></td>
                        [% ELSE %]
                            <td><a href="[% task.viewURL %]" class="btn-inside-panels">[% Lang.txt('View and Process') %]</a></td>
                        [% END %]

                    [% ELSE %]
                        <td></td>
                    [% END %]
                </tr>
		    [% END %]

		</tbody>
	</table>
</div>

<div class="col-md-3 dashboard-sidebar">
	<div class="sidebar-box">
		<h3 class="panel-header">[% Lang.txt('Task at a Glance') %]</h3>
		<ul>
			<li>[% Lang.txt('New Registrations')%]: <b>[% IF TaskCounts.NEW %][% TaskCounts.NEW %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Renewals') %]: <b>[% IF TaskCounts.RENEWAL %][% TaskCounts.RENEWAL %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Transfers') %]: <b>[% IF TaskCounts.TRANSFER %][% TaskCounts.TRANSFER %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Request Access') %]: <b>[% IF TaskCounts.ACCESS %][% TaskCounts.ACCESS %][% ELSE %]0[% END %]</b></li>
		</ul>
		<ul>
			<li>[% Lang.txt('Total Task Active') %]: <b>[% IF TaskCounts.ACTIVE %][% TaskCounts.ACTIVE %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Total Task On Hold') %]: <b>[% IF TaskCounts.HOLD %][% TaskCounts.HOLD %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Total Task Pending') %]: <b>[% IF TaskCounts.PENDING %][% TaskCounts.PENDING %][% ELSE %]0[% END %]</b></li>
			<li>[% Lang.txt('Total Task Rejected') %]: <b>[% IF TaskCounts.REJECTED %][% TaskCounts.REJECTED %][% ELSE %]0[% END %]</b></li>
		</ul>
	</div>
    <div class="sidebar-box clearfix">
        <h3 class="panel-header">[% Lang.txt('Quick Search') %]</h3>
        <div class="col-md-12">
            <div class="input-group">
                <input class="form-control" type="text">
                <span class="input-group-addon"><i class="fa fa-search"></i></span>
            </div>
            <a class="show-advanced-search">[% Lang.txt('Advanced Search') %]</a>
            <div class="advanced-search-fields clearfix">
                <span><input type="checkbox" value="checkbox">[% Lang.txt('Player') %]</span>
                <span><input type="checkbox" value="checkbox">[% Lang.txt('Official') %]</span>
                <span><input type="checkbox" value="checkbox">[% Lang.txt('Coach') %]</span>
                <span><input type="checkbox" value="checkbox">[% Lang.txt('Pending') %]</span>
                <span><input type="checkbox" value="checkbox">[% Lang.txt('Referee') %]</span>
            </div>
        </div>
    </div>
    [% IF CurrentLevel == 3 %]
        <div class="sidebar-box">
            <h3 class="panel-header">[% Lang.txt('Quick Links') %]</h3>
            <ul class="quick-links">
                <li><a href="main.cgi?client=[% client %]&a=PF_&dtype=PLAYER"><span class="fa fa-plus"></span>[% Lang.txt('Start a New Player Registration') %]</a></li>
                <!--<li><a href="main.cgi?client=[% client %]&a=PRA_T"><span class="fa fa-random"></span>[% Lang.txt('Request or Start a Transfer') %]</a></li>-->
                <li><a href="main.cgi?client=[% client %]&a=PENDPR_"><span class="fa fa-newspaper-o"></span>[% Lang.txt('List Pending Registrations') %]</a></li>
                <!--<li><a href="main.cgi?client=[% client %]&a=REP_SETUP"><span class="fa fa-paste"></span>[% Lang.txt('Reports') %]</a></li>-->
            </ul>
        </div>
    [% ELSE %]
        <div class="sidebar-box">
            <h3 class="panel-header">[% Lang.txt('Quick Links') %]</h3>
            <ul class="quick-links">
                <li><a href="main.cgi?client=[% client %]&a=PF_"><span class="fa fa-plus"></span>[% Lang.txt('Start a New Registration') %]</a></li>
                [% IF MA_allowTransfer %]
                    <!--<li><a href="main.cgi?client=[% client %]&a=PRA_T"><span class="fa fa-random"></span>[% Lang.txt('Request or Start a Transfer') %]</a></li>-->
                [% END %]
                <li><a href="main.cgi?client=[% client %]&a=PENDPR_"><span class="fa fa-newspaper-o"></span>[% Lang.txt('List Pending Registrations') %]</a></li>
                <!--<li><a href="main.cgi?client=[% client %]&a=REP_SETUP"><span class="fa fa-paste"></span>[% Lang.txt('Reports') %]</a></li>-->
            </ul>
        </div>
    [% END %]
</div>

<script src = "//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    jQuery().ready(function() {
        jQuery.fn.dataTableExt.afnFiltering.push(
            function(settings, data, dataIndex) {
                var index = jQuery("select#l_intTaskType").find(":selected").index();

                var myRowClass = settings.aoData[dataIndex].nTr.className;
                var myRowClasses = myRowClass.split(/\s+/);
                if(index == 1 && jQuery.inArray("new-task", myRowClasses) == 1){
                    return true;
                }  else if(index == 0) {
                    return true;
                }
            }
        );

        var dttable = jQuery('#worktasks').dataTable({
            //"order": [[1, "desc"]],
            "order": [],
            "lengthMenu": [[50, 100, -1], [50, 100, "All"]]
        });

        var api = dttable.api();
        var taskscol = api.column(0);

        jQuery("select#l_intTaskType").fcToggle('rebuild');
        jQuery("select#l_intTaskType").on('change', function(){
            api.draw();
        });

        var tasktype = jQuery("select.filter-tasks");

        jQuery(tasktype).on('change', function(){
            var index = jQuery(this).find(":selected").index();
            var val = jQuery.fn.dataTable.util.escapeRegex(jQuery(this).val());

            taskscol
                .search( val ? val : '', true, false )
                .draw();               
        });

        var taskstatus = jQuery("select.filter-status");

        var tstatuscol = api.column(2);
        jQuery(taskstatus).on('change', function(){
            var index = jQuery(this).find(":selected").index();
            var val = jQuery.fn.dataTable.util.escapeRegex(jQuery(this).val());

            tstatuscol
                .search( val ? '^'+val+'$' : '', true, false )
                .draw();               

        });

        var tdate = jQuery("select.sort-date");
        var tdatecol = api.column(1);

        jQuery(tdate).on('change', function(){
            var index = jQuery(this).find(":selected").index();
            var val = jQuery.fn.dataTable.util.escapeRegex(jQuery(this).val());

            tdatecol
                .order(val).draw();
        });

    });

</script>

